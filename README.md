# TimeWeb AI ChatBot

Полноценный пример приложения, которое принимает вопросы с веб-виджета, ищет релевантные ответы в базе знаний OpenSearch и передаёт их в TimeWeb AI-Агент для генерации итогового ответа.

## Архитектура проекта

```
.
├── app
│   ├── api
│   │   ├── __init__.py
│   │   └── routes.py           # эндпоинты FastAPI
│   ├── core
│   │   └── config.py           # конфигурация и работа с переменными окружения
│   ├── services
│   │   ├── opensearch_client.py# взаимодействие с OpenSearch
│   │   └── timeweb_agent.py    # запросы в TimeWeb AI-Агента
│   └── main.py                 # точка входа FastAPI
├── widget
│   ├── index.html              # пример встраиваемого виджета
│   ├── chatbot.js              # логика работы виджета
│   └── styles.css              # оформление виджета
├── tests
│   └── test_health.py          # пример автотеста
├── Dockerfile
├── docker-compose.yml
├── pyproject.toml
├── Makefile
└── .env.example
```

## Подготовка окружения

1. Скопируйте `.env.example` в `.env` и заполните переменные.
2. Создайте виртуальное окружение и установите зависимости:

```bash
make install
```

3. Запустите сервис локально:

```bash
make dev
```

Сервис будет доступен на `http://localhost:8000`.

## Настройка OpenSearch

- Создайте индекс `knowledge-base` (или другой, указанный в `.env`).
- Структура документов:
  ```json
  {
    "title": "Название статьи",
    "content": "Полный текст ответа",
    "url": "https://support.example.com/article"
  }
  ```
- Убедитесь, что учётные данные (логин/пароль) имеют права на чтение индекса.

## Подключение TimeWeb AI-Агентов

1. Получите API-токен в панели TimeWeb Cloud.
2. Создайте или выберите готовый AI-Агент.
3. Укажите `TIMEWEB_AGENT_ID` и `TIMEWEB_API_TOKEN` в `.env`.
4. При необходимости измените параметры генерации (`TIMEWEB_TEMPERATURE`, `TIMEWEB_TOP_P`).

Сервис отправляет агенту найденный контекст и вопрос пользователя, ожидая JSON-ответ формата:

```json
{
  "output": {
    "answer": "Готовый текст ответа"
  }
}
```

При необходимости адаптируйте `TimewebAgentClient` под текущую спецификацию API.

## Веб-виджет

Файлы в директории `widget/` можно разместить на вашем сайте или встроить как часть существующего кода. Для быстрого теста откройте `widget/index.html`, при необходимости измените атрибут `data-api-endpoint` на адрес, где доступен ваш backend на TimeWeb.

Чтобы встроить виджет в существующую страницу:

```html
<link rel="stylesheet" href="https://your-cdn/widget/styles.css" />
<div class="twb-chatbot" data-api-endpoint="https://your-domain/chat"></div>
<script src="https://your-cdn/widget/chatbot.js" defer></script>
```

## Запуск в Docker / TimeWeb Cloud

### Локально с Docker

```bash
docker compose up --build
```

### Развёртывание на TimeWeb Cloud

1. Создайте репозиторий в GitHub и загрузите код проекта.
2. В панели TimeWeb создайте приложение типа «Контейнер».
3. Укажите репозиторий GitHub и команду запуска:
   ```
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```
4. Добавьте переменные окружения из `.env` в настройках контейнера.
5. Настройте маршрутизацию домена/поддомена на контейнер.
6. При необходимости подключите HTTPS через встроенный менеджер сертификатов TimeWeb.

## Тестирование

```bash
make test
```

## Интеграция с внешними сервисами

- **OpenSearch** — отвечает за поиск по базе знаний. Интеграция реализована в `app/services/opensearch_client.py`.
- **TimeWeb AI-Агент** — генерирует финальный ответ с учётом найденного контекста. Реализация в `app/services/timeweb_agent.py`.

При необходимости можно расширить логику объединением нескольких источников данных или добавлением очередей сообщений.

## Поддержка и расширение

- Добавьте кэширование результатов поиска для популярных запросов.
- Реализуйте поддержку истории диалога, передавая предыдущие сообщения в агент.
- Подключите систему логирования и мониторинга (например, Prometheus + Grafana).

## Лицензия

Проект распространяется под лицензией MIT. Используйте и адаптируйте под свои задачи.
